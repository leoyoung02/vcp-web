<!-- drawer component -->
<div id="drawer-right"
    class="shadow fixed top-0 right-0 z-40 h-screen transition-transform translate-x-full bg-[#F5F6F8] w-96 rounded-lg"
    tabindex="-1" aria-labelledby="drawer-right-label"
    [ngStyle]="{
        'hidden': !canChat && isMobile,
        'bottom': '0px !important',
        'height': '800px !important',
        'top': isMobile ? '0px !important' : 'initial !important',
        'right': isMobile ? 'initial !important' : '0px !important',
    }"
    [ngClass]="{
        'z-50': isMobile && canChat,
        'left-0': isMobile,
    }"
    style="filter:drop-shadow(0 3.46px 3.46px rgb(0 0 0 / 0.25))">
    <div class="fixed top-0 start-0 z-50 flex justify-between w-full">
        <div class="flex items-center gap-3 flex-wrap py-3 rounded-none sm:rounded-none md:rounded-t-lg lg:md:rounded-t-lg w-full px-4"
            [ngStyle]="{'background-color': buttonColor}">
            <div class="flex items-center [&>*]:w-[2.7rem] [&>*]:h-[2.7rem] [&>*]:rounded-full [&>*]:bg-purple-400 [&>*]:p-0.5 [&>*]:-ml-2 [&>*:hover]:z-20 [&>*:hover]:scale-105 [&>*>img]:h-full [&>*>img]:w-full [&>*>img]:rounded-full [&>*>img]:object-cover transition-all duration-300">
                <div>
                    <img [src]="userImage" class="w-10 h-10 object-cover" [alt]="userName" loading="lazy">
                </div>
                <div>
                    <img [src]="image" class="w-10 h-10 object-cover" [alt]="firstName" loading="lazy">
                </div>
            </div>
            <div class="text-white">
                <h2 class="font-semibold">{{ userName }}, {{ firstName }}</h2>
            </div>
            <div>
                <button type="button" data-drawer-hide="drawer-right" aria-controls="drawer-right"
                    class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-black rounded-lg text-sm w-8 h-8 absolute top-4 end-5 sm:end-5 mmd:end-2.5 lg:end-2.5 inline-flex items-center justify-center">
                    <svg class="w-3 h-3 text-white hover:text-black" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                    </svg>
                    <span class="sr-only">Close menu</span>
                </button>
            </div>
        </div>
    </div>
    <div class="bg-white h-full relative mt-16">
        <div class="h-[calc(100vh_-_136px)] sm:h-[calc(100vh_-_136px)] md:h-[calc(100%_-_566px)] lg:h-[calc(100%_-_566px)] p-4 overflow-y-auto">
            <div *ngIf="canChat">
                <div class="text-sm font-semibold mb-2 uppercase">
                    {{ 'settings.personaldata' | translate }}
                </div>
                <div class="py-3 px-4 bg-yellow-50 rounded-lg">
                    <ng-container *ngFor="let field of userData">
                        <div *ngIf="field?.value && field?.value != '-'" 
                            class="leading-3 space-y-0.5 font-medium text-left rtl:text-right flex flex-row items-center justify-between">
                            <div class="text-sm font-semibold">{{ field?.label }}:</div>
                            <div class="text-sm">{{ field?.value }}</div>
                        </div>
                    </ng-container>
                </div>
                <div class="py-4" *ngIf="messages?.length > 0">
                    <ng-container *ngFor="let row of messages; let i = index;">
                        <div class="my-4 relative"
                            [ngClass]="{'mt-8': i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id) }">
                            <div>
                                <div class="flex gap-4">
                                    <ng-container *ngIf="row.sender_id == userId">
                                        <div class="text-sm text-white p-4 leading-5 w-full bg-blue-600 shadow relative before:content-['']"
                                            [ngClass]="{
                                                'rounded-lg before:absolute before:w-3 before:h-3 before:bg-blue-600 before:rotate-45 before: before:-right-1 before:top-4': i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id),
                                                'rounded-l-lg rounded-br-lg': !(i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id))
                                            }">
                                            <p [innerHtml]="row.message"></p>
                                            <div class="mt-2.5 text-xs text-white leading-none font-semibold">{{ row.date | date: 'dd MMM HH:mm' }}</div>
                                        </div>
                                        <div class="shrink-0 w-12 h-12 rounded-full bg-purple-400 p-0.5" *ngIf="i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id)">
                                            <img [src]="userImage" alt="" class="h-full w-full object-cover rounded-full">
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="row.sender_id != userId">
                                        <div class="shrink-0 w-12 h-12 rounded-full bg-purple-400 p-0.5" *ngIf="i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id)">
                                            <img [src]="image" alt="" class="h-full w-full object-cover rounded-full">
                                        </div>
                                        <div class="text-sm p-4 leading-5 w-full bg-gray-100 shadow relative before:content-['']"
                                            [ngClass]="{
                                                'rounded-lg before:absolute before:w-3 before:h-3 before:bg-gray-100 before:rotate-45 before: before:-left-1 before:top-4': i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id),
                                                'rounded-r-lg rounded-bl-lg': !(i == 0 || (i > 0 && messages[i - 1].sender_id != messages[i].sender_id))
                                            }">
                                            <p [innerHtml]="row.message"></p>
                                            <div class="mt-2.5 text-xs text-gray-500 leading-none font-semibold">{{ row.date | date: 'dd MMM HH:mm'  }}</div>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
            <div *ngIf="!canChat">
                <a [routerLink]="['/users/account-recharge']" 
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-center text-white rounded-lg hover:bg-black focus:ring-4 focus:ring-blue-300 focus:outline-none"
                    [ngStyle]="{'background-color': buttonColor}">
                    {{ 'professionals.recharge' | translate }}
                    <svg class="rtl:rotate-180 w-3.5 h-3.5 ms-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 14 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M1 5h12m0 0L9 1m4 4L9 9" />
                    </svg>
                </a>
            </div>
        </div>
        <div *ngIf="canChat" 
            class="w-full flex justify-between bg-[#f8f4f4]">
            <textarea class="flex-grow m-2 py-2 px-4 mr-1 w-full px-0 text-sm text-gray-900 bg-white border border-0 resize-none rounded-lg" 
                style="outline: none;"
                placeholder="{{ 'buddy.message' | translate }}"
                [ngClass]="{'bg-red-50 border border-red-500 text-red-900 placeholder-red-700': formSubmitted && !message }"
                [(ngModel)]="message"
                [ngModelOptions]="{standalone: true}" 
                required>
            </textarea>
            <button class="m-2 outline-none" [disabled]="formSubmitted" (click)="sendMessage()">
                <svg
                    [ngStyle]="{'color': buttonColor}"
                    class="svg-inline--fa fa-paper-plane fa-w-6 w-6 h-6 py-2 mr-2"
                    aria-hidden="true"
                    focusable="false"
                    data-prefix="fas"
                    data-icon="paper-plane"
                    role="img"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512"
                >
                <path
                    fill="currentColor"
                    d="M476 3.2L12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"
                />
                </svg>
            </button>
        </div>
    </div>
</div>